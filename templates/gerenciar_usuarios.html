{% extends 'base.html' %}

{% block title %}Gerenciar Usuários{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
    }
    h2 { 
        color: #2962FF; 
        text-align: center; 
        margin-bottom: 30px;
        font-size: 2em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background-color: #2a2a2a;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        overflow: hidden;
    }
    th, td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid #3a3a3a;
    }
    th {
        background-color: #333;
        color: #e0e0e0;
        font-weight: 500;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: #313131; }
    .status-expired { color: #f44336; font-weight: bold; }
    .status-active { color: #4caf50; font-weight: bold; }
    .actions button {
        padding: 8px 12px;
        margin: 0 4px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: white;
        font-weight: 500;
        transition: transform 0.2s;
    }
    .actions button:hover { transform: translateY(-2px); }
    .btn-extend { background-color: #2962FF; }
    .btn-reset { background-color: #ffc107; color: #1e1e1e;}
    .btn-delete { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Gerenciamento de Usuários</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Usuário</th>
                <th>HWID (início)</th>
                <th>Expira em</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="user-table-body">
            </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function fetchUsers() {
    fetch('/users')
        .then(response => response.json())
        .then(users => {
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';
            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum usuário encontrado.</td></tr>';
                return;
            }
            users.forEach(user => {
                const expirationDate = user.expiration_date ? new Date(user.expiration_date) : null;
                const now = new Date();
                
                const statusHtml = !expirationDate ? `<span class="status-expired">Sem Licença</span>`
                                 : (expirationDate < now ? `<span class="status-expired">Expirado</span>`
                                 : `<span class="status-active">Ativo</span>`);

                const formattedDate = expirationDate ? expirationDate.toLocaleString('pt-BR') : 'N/A';
                const hwidDisplay = user.hwid ? user.hwid.substring(0, 15) + '...' : 'Não vinculado';

                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${hwidDisplay}</td>
                        <td>${formattedDate}</td>
                        <td>${statusHtml}</td>
                        <td class="actions">
                            <button class="btn-extend" onclick="extendAccess(${user.id}, '${user.username}')">Estender</button>
                            <button class="btn-reset" onclick="resetHwid(${user.id}, '${user.username}')">Resetar HWID</button>
                            <button class="btn-delete" onclick="deleteUser(${user.id}, '${user.username}')">Deletar</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        });
}

function extendAccess(userId, username) {
    const days = prompt(`Estender acesso para "${username}" por quantos dias?`, "30");
    if (days === null || isNaN(parseInt(days)) || parseInt(days) <= 0) return;
    
    fetch(`/users/extend_access/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ days_to_add: days })
    })
    .then(r => r.json())
    .then(data => { alert(data.message || data.mensagem); fetchUsers(); });
}

function resetHwid(userId, username) {
    if (!confirm(`Tem certeza que deseja resetar o HWID de "${username}"?`)) return;
    fetch(`/users/reset_hwid/${userId}`, { method: 'POST' })
    .then(() => { alert('HWID resetado com sucesso!'); fetchUsers(); });
}

function deleteUser(userId, username) {
    if (!confirm(`ATENÇÃO: Tem certeza que deseja DELETAR o usuário "${username}"? Esta ação é irreversível.`)) return;
    fetch(`/admin/users/delete/${userId}`, { method: 'DELETE' })
    .then(() => { alert('Usuário deletado com sucesso!'); fetchUsers(); });
}

window.onload = fetchUsers;
</script>
{% endblock %}